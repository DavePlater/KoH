<html>
<head>
<title>KoH Quest Mapping</title>
<meta charset="UTF-8">
<meta name="author" content="KingPlater" />
<meta name="description" content="https://daveplater.github.io/KoH/Quests.html" />
<style type="text/css">
	.smallLabel {background-color:orange; font-size: smaller; border: 1px solid black; padding: 2px 2px 2px 2px; margin: 2px 2px 2px 2px;}
	.CurrentQuest { font-weight:bold; color:red;}
	.PastQuest { }
	.FutureQuest { }
</style>
<script type="text/javascript">

	function GetSpanFromTimes(T1, T2)
	{
		var retval={'H':0, 'M':0, 'S':0, 'hasPassed':false };
		retval["toString"]=function(){ return (this.hasPassed?"-":"")+ this.H+"h"+this.M+"m"+this.S+"s";}
		var SecsPerHour=60*60;
		var SecsPerMinute=60;
		
		var diff = T1  - T2;
		var Seconds_from_T1_to_T2 = diff / 1000;
		//now figure out H,M,S
		retval["hasPassed"]=(Seconds_from_T1_to_T2<0);
		var Multiplier=(Seconds_from_T1_to_T2<0)?-1.0:1.0;
		var hold=Math.abs(Seconds_from_T1_to_T2);
		while(hold>SecsPerHour)		{			retval.H++;			hold=hold-SecsPerHour;		}
		while(hold>SecsPerMinute)		{			retval.M++;			hold=hold-SecsPerMinute;		}
		while(hold>1)		{			retval.S++;			hold=hold-1;		}
		
		return retval;
	}
	class QuestAndTime 
	{  
		constructor(Name, EpochTime) {    this.Name = Name;    this.EpochTime = EpochTime;  }
		//Method
		setRow(tr)
		{
			if(tr!=undefined)
			{
				tr.innerHTML="";//clear it?
				var newCell;
				newCell = tr.insertCell(0);//last
				//var diff = new Date().getTime() - this.EpochTime;
				//var Seconds_from_T1_to_T2 = dif / 1000;
				var MilisPerMinute=(60*1000);
				var StartTime = this.EpochTime + (5*MilisPerMinute);
				//console.log(MilisPerMinute);
				var oSpan = GetSpanFromTimes(	StartTime, new Date().getTime());
				//console.log(oSpan);
				//var strSpan=tspan.getHours()+"h"+tspan.getMinutes()+"m"+tspan.getSeconds()+"s";
				var strSpan=oSpan.toString();
				newCell.innerHTML=strSpan;
				newCell = tr.insertCell(0);
				newCell.innerHTML=new Date(this.EpochTime).toString();
				newCell = tr.insertCell(0);
				/*var strHTMLName="";
				var dtBiomeChangeCheck=new Date(this.EpochTime);
				if(dtBiomeChangeCheck.getUTCHours()==9+12){	strHTMLName="<span class=\"smallLabel\">BIOME CHANGE</span> ";	}
				strHTMLName+=this.Name;*/
				newCell.innerHTML=this.Name;
			}
		}
	} //end of class
	
	class Cycle
	{
		constructor(aryItems) {    this.aryCycle = aryItems;  }
		//Method(s)
		getAt(idx) { return this.aryCycle[idx]; } //unprotected?
		findIDXOfValue(_value)
		{
			var retval=-1;//or -1??
			for(var i=0;i<this.aryCycle.length;i++)
			{
				if(_value == this.aryCycle[i])			{				retval = i; break;			}
			}
			return retval;
		}
		MoveIDXForward(StartIDX, NumToMove)
		{
			var retval=0;
			if(StartIDX >=0 && StartIDX < this.aryCycle.length)
			{
				NumToMove = (NumToMove % this.aryCycle.length);
				retval=StartIDX;
				for(var i=0; i<NumToMove;i++)
				{
					retval++;
					if(retval > (this.aryCycle.length-1)){ retval=0; }
				}
			}
			return retval;
		}
		MoveIDXBackward(StartIDX, NumToMove)
		{
			var retval=0;
			if(StartIDX >=0 && StartIDX < this.aryCycle.length)
			{
				NumToMove = (NumToMove % this.aryCycle.length);
				retval=StartIDX;
				for(var i=0; i<NumToMove;i++)
				{
					retval--;
					if(retval <0) { retval=(this.aryCycle.length-1); }
				}
			}
			return retval;
		}
	} //end of class
</script>
<script type="text/javascript">
	var tTimeUpdater=-1;
	var OneHour = (60*60*1000);
	var OneDay= (24*OneHour);
	var NumBack=3;
	var NumForward=11;
	//
	var myQuests = new Cycle(["Construction", "Troop Training", "Monster Slaying", "Gathering", "Research", "Troop Training", "Monster Slaying","Might Growth", "Gathering", "Troop Training", "Monster Slaying"]);
	var ConstKnownValue= new QuestAndTime("Research",1518789600000);//{ Name:"Research", EpochTime:1487253600000}; //something like 2/16/2017 
	// "Might", 1518802310007 //fix for being on an hour interval
	// Biome change at "2pm vancouver,bc time" durring the summer, they are UTC-7 then, so 9pm UTC
	// Wed, 17 Oct 2018 21:00:00 GMT was start og SWAMP day
	var myBiomes=new Cycle(["Grasslands", "Badlands", "Swamp"]);	
	var ConstBiomeKnownValue= new QuestAndTime("Swamp",1539810000000);
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////	
	function getParameterByName(name, url) 
	{
	    if (!url) url = window.location.href;
	    name = name.replace(/[\[\]]/g, "\\$&");
	    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
	    if (!results) return null;
	    if (!results[2]) return '';
	    return decodeURIComponent(results[2].replace(/\+/g, " "));
	}

	//function GetHoursDiff(date1, date2)	{		return  Math.abs(date1 - date2) / 36e5;	}
	function SE(strElementID, strHTMLValue)
	{
		var obj=document.getElementById(strElementID);
		if(obj!=undefined && obj["innerHTML"] != undefined) 	{			obj.innerHTML=strHTMLValue;		}
	}
	function AppendRow(objQuestTime, RowMarker)
	{
		var tblDerived = document.getElementById("tblDerived");
		if(tblDerived!=undefined && objQuestTime!=undefined)
		{
			var newRow   = tblDerived.insertRow(tblDerived.rows.length);
			if(RowMarker==0){newRow.className ="CurrentQuest";}
			else if(RowMarker==-1){newRow.className ="PastQuest";}
			else if(RowMarker==1){newRow.className ="FutureQuest";}
			objQuestTime. setRow(newRow);
		}
	}
	function AppendBiomeRow(objQuestTime, RowMarker)
	{
		var tblBiomeList = document.getElementById("tblBiomeList");
		if(tblBiomeList!=undefined && objQuestTime!=undefined)
		{
			var newRow   = tblBiomeList.insertRow(tblBiomeList.rows.length);
			if(RowMarker==0){newRow.className ="CurrentQuest";}
			else if(RowMarker==-1){newRow.className ="PastQuest";}
			else if(RowMarker==1){newRow.className ="FutureQuest";}
			objQuestTime.setRow(newRow);
		}
	}
	function AppendBiomeChangeMarker()
	{
		var tblDerived = document.getElementById("tblDerived");
		if(tblDerived!=undefined )
		{
			var newRow   = tblDerived.insertRow(tblDerived.rows.length);
			newRow.innerHTML="";//clear it?
			var newCell;
			newCell = newRow.insertCell(0);//last
			
			newCell = newRow.insertCell(0);//last
			newCell.innerHTML="Biome has cycled";
			newCell = newRow.insertCell(0);//last
			newCell.innerHTML= "<span class=\"smallLabel\">BIOME CHANGE</span>";
		}
	}
	
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
	
	function tmTick()
	{
		UpdateUITimes();
		//
		var tblDerived = document.getElementById("tblDerived");
		if(tblDerived!=undefined){tblDerived.innerHTML="";}
		SetPrevCurNextValues();
		//
		var tblBiomeList = document.getElementById("tblBiomeList");
		if(tblBiomeList!=undefined){tblBiomeList.innerHTML="";}
		SetPrevCurNextBiomeValues();
	}
	function UpdateUITimes()
	{
		var dtNow = new Date(); //dtNow = new Date(2018,1,16,9,0,0);
		SE("lblClientTime",dtNow.toString());
		SE("lblUTCTime",dtNow.toUTCString());
	}	
	function CompareTo(tm1, tm2)
	{
		var retval = 0;//they are equal
		if(tm1==tm2){retval=0;}
		else if(tm1<tm2){retval=-1;}
		else if(tm1>tm2){retval=1;}
		return retval;
	}
	function SetPrevCurNextBiomeValues()
	{
		var KnownBiomeIDX=myQuests.findIDXOfValue(ConstBiomeKnownValue.Name);
		if(KnownBiomeIDX!=-1)
		{
			var nowEpoch = new Date().getTime();
			var Diff= nowEpoch - ConstBiomeKnownValue.EpochTime;			
			var NumHours = Math.floor(Diff / OneDay);
			
			var currentIDX = myBiomes.MoveIDXForward(KnownBiomeIDX,NumHours);
			var CurrentEpoch=(ConstBiomeKnownValue.EpochTime+(OneDay*NumHours));
			
			var UIStartEpoch =  CurrentEpoch - (NumBack*OneDay)
			var UIStartIDX = myBiomes.MoveIDXBackward(currentIDX,NumBack);
			for(var i=0; i < (1+NumBack+NumForward);i++)
			{
				var qt = new QuestAndTime( myBiomes.getAt(myBiomes.MoveIDXForward(UIStartIDX,i)), UIStartEpoch + (i*OneDay));
				AppendBiomeRow(qt, CompareTo(qt.EpochTime, CurrentEpoch) );
			}
		}
	}
	function SetPrevCurNextValues()
	{
		//so! search through aryCycle and find ConstKnownValue.Name
		var KnownIDX=myQuests.findIDXOfValue(ConstKnownValue.Name);
		if(KnownIDX!=-1)
		{
			var nowEpoch = new Date().getTime();
			var Diff= nowEpoch - ConstKnownValue.EpochTime;			
			var NumHours = Math.floor(Diff / OneHour);			
			
			var currentIDX = myQuests.MoveIDXForward(KnownIDX,NumHours);
			var CurrentEpoch=(ConstKnownValue.EpochTime+(OneHour*NumHours));
		
			var UIStartEpoch =  CurrentEpoch - (NumBack*OneHour)
			var UIStartIDX = myQuests.MoveIDXBackward(currentIDX,NumBack);
			for(var i=0; i < (1+NumBack+NumForward);i++)
			{
				var qt = new QuestAndTime( myQuests.getAt(myQuests.MoveIDXForward(UIStartIDX,i)), UIStartEpoch + (i*OneHour));
				//var AmIOld = qt.EpochTime < CurrentEpoch; //-1
				//var AmICurrent = qt.EpochTime == CurrentEpoch;//0
				//var AmIFuture = qt.EpochTime > CurrentEpoch;//1
				var dtBiomeChangeCheck=new Date(qt.EpochTime);
				if(dtBiomeChangeCheck.getUTCHours()==9+12)
				{
					AppendBiomeChangeMarker();
				}
				AppendRow(qt, CompareTo(qt.EpochTime, CurrentEpoch) );
			}
		}
	}
	function bodyLoad()
	{
		NumBack=parseInt((localStorage.getItem("QuestTimer_NumBack")||3));
		NumForward=parseInt((localStorage.getItem("QuestTimer_NumForward")||11));
		//force save
		localStorage.setItem("QuestTimer_NumBack", NumBack);
		localStorage.setItem("QuestTimer_NumForward", NumForward);
		//
		UpdateUITimes();
		var trKnownValue = document.getElementById("trKnownValue");
		if(trKnownValue!=undefined){	ConstKnownValue.setRow(trKnownValue);}
		SetPrevCurNextValues();
		SetPrevCurNextBiomeValues()
		var oAutoUpdate=getParameterByName("AutoUpdate");
		//console.log(oAutoUpdate);
		if(oAutoUpdate=="true")
		{
			tTimeUpdater = window.setInterval(function (){tmTick();}, 1000);
		}
	}
	
</script>
</head>
<body onload="bodyLoad();">
	<table cellpadding="5" cellspacing="5" border="1px">
		<tr><th>Local Time:</th><td><span id="lblClientTime"></span></td></tr>
		<tr><th>UTC Time:</th><td><span id="lblUTCTime"></span></td></tr>
	</table>
<a href="?AutoUpdate=true">AutoUpdate</a> - <a href="?AutoUpdate=false">No AutoUpdate</a><br/>
	<br/>
	<table cellpadding="5" cellspacing="5" border="1px">
		<thead style="display:none;">
			<tr><th colspan="3">Known Value</th><tr>
			<tr id="trKnownValue"></tr>
			<tr><td colspan="2" id="Scratch"></td></tr>
		</thead>
		<thead><tr><th>Quest Name</th><th>Quest Time</th><th>Start Time</th></tr></thead>
		
		<tbody id="tblDerived">
		</tbody>
	</table>
	<table cellpadding="5" cellspacing="5" border="1px">
		<thead><tr><th>Biome Name</th><th>Quest Time</th><th>Start Time</th></tr></thead>
		<tbody id="tblBiomeList">
		</tbody>
	</table>
</body>
</html>
