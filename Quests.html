<html>
<head>
<title>KoH Quest Mapping</title>
<meta charset="UTF-8">
<meta name="author" content="KingPlater" />
<meta name="description" content="https://daveplater.github.io/KoH/Quests.html" />
<style type="text/css">
	.CurrentQuest { font-weight:bold; color:red;}
</style>
<script type="text/javascript">

	function GetSpanFromTimes(T1, T2)
	{
		var retval={'H':0, 'M':0, 'S':0, 'hasPassed':false };
		retval["toString"]=function(){ return (this.hasPassed?"-":"")+ this.H+"h"+this.M+"m"+this.S+"s";}
		var SecsPerHour=60*60;
		var SecsPerMinute=60;
		
		var diff = T1  - T2;
		var Seconds_from_T1_to_T2 = diff / 1000;
		//now figure out H,M,S
		retval["hasPassed"]=(Seconds_from_T1_to_T2<0);
		var Multiplier=(Seconds_from_T1_to_T2<0)?-1.0:1.0;
		var hold=Math.abs(Seconds_from_T1_to_T2);
		if(retval.hasPassed==true){hold=hold-(5*SecsPerMinute);} else {hold=hold+(5*SecsPerMinute);}
		while(hold>SecsPerHour)		{			retval.H++;			hold=hold-SecsPerHour;		}
		while(hold>SecsPerMinute)		{			retval.M++;			hold=hold-SecsPerMinute;		}
		while(hold>1)		{			retval.S++;			hold=hold-1;		}
		
		return retval;
	}
	class QuestAndTime 
	{  
		constructor(Name, EpochTime) {    this.Name = Name;    this.EpochTime = EpochTime;  }
		//Method
		setRow(tr)
		{
			if(tr!=undefined)
			{
				tr.innerHTML="";//clear it?
				var newCell;
				newCell = tr.insertCell(0);//last
				//var diff = new Date().getTime() - this.EpochTime;
				//var Seconds_from_T1_to_T2 = dif / 1000;
				
				var oSpan = GetSpanFromTimes(	this.EpochTime, new Date().getTime());
				//console.log(oSpan);
				
				//var strSpan=tspan.getHours()+"h"+tspan.getMinutes()+"m"+tspan.getSeconds()+"s";
				var strSpan=oSpan.toString();
				newCell.innerHTML=strSpan;
				newCell = tr.insertCell(0);
				newCell.innerHTML=new Date(this.EpochTime).toString();
				newCell = tr.insertCell(0);
				newCell.innerHTML=this.Name;
			}
		}
	} //end of class
	
	class Cycle
	{
		constructor(aryItems) {    this.aryCycle = aryItems;  }
		//Method(s)
		getAt(idx) { return this.aryCycle[idx]; } //unprotected?
		findIDXOfValue(_value)
		{
			var retval=-1;//or -1??
			for(var i=0;i<this.aryCycle.length;i++)
			{
				if(_value == this.aryCycle[i])			{				retval = i; break;			}
			}
			return retval;
		}
		MoveIDXForward(StartIDX, NumToMove)
		{
			var retval=0;
			if(StartIDX >=0 && StartIDX < this.aryCycle.length)
			{
				NumToMove = (NumToMove % this.aryCycle.length);
				retval=StartIDX;
				for(var i=0; i<NumToMove;i++)
				{
					retval++;
					if(retval > (this.aryCycle.length-1)){ retval=0; }
				}
			}
			return retval;
		}
		MoveIDXBackward(StartIDX, NumToMove)
		{
			var retval=0;
			if(StartIDX >=0 && StartIDX < this.aryCycle.length)
			{
				NumToMove = (NumToMove % this.aryCycle.length);
				retval=StartIDX;
				for(var i=0; i<NumToMove;i++)
				{
					retval--;
					if(retval <0) { retval=(this.aryCycle.length-1); }
				}
			}
			return retval;
		}
	} //end of class
</script>
<script type="text/javascript">
	var tTimeUpdater=-1;
	var OneHour = (60*60*1000);
	var NumBack=3;
	var NumForward=8;
	//
	var myQuests = new Cycle(["Construction", "Troop Training", "Monster Slaying", "Gathering", "Research", "Troop Training", "Monster Slaying","Might Growth", "Gathering", "Troop Training", "Monster Slaying"]);
	var ConstKnownValue= new QuestAndTime("Research",1518789600000);//{ Name:"Research", EpochTime:1487253600000}; //something like 2/16/2017 
	// "Might", 1518802310007 //fix for being on an hour interval
	
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////	
	function getParameterByName(name, url) 
	{
	    if (!url) url = window.location.href;
	    name = name.replace(/[\[\]]/g, "\\$&");
	    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
	    if (!results) return null;
	    if (!results[2]) return '';
	    return decodeURIComponent(results[2].replace(/\+/g, " "));
	}

	//function GetHoursDiff(date1, date2)	{		return  Math.abs(date1 - date2) / 36e5;	}
	function SE(strElementID, strHTMLValue)
	{
		var obj=document.getElementById(strElementID);
		if(obj!=undefined && obj["innerHTML"] != undefined) 	{			obj.innerHTML=strHTMLValue;		}
	}
	function AppendRow(objQuestTime, AmICurrent)
	{
		var tblDerived = document.getElementById("tblDerived");
		if(tblDerived!=undefined && objQuestTime!=undefined)
		{
			var newRow   = tblDerived.insertRow(tblDerived.rows.length);
			if(AmICurrent==true){newRow.className ="CurrentQuest";}
			objQuestTime. setRow(newRow);
		}
	}
	
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
	
	function tmTick()
	{
		UpdateUITimes();
		var tblDerived = document.getElementById("tblDerived");
		if(tblDerived!=undefined){tblDerived.innerHTML="";}
		SetPrevCurNextValues();
	}
	function UpdateUITimes()
	{
		var dtNow = new Date(); //dtNow = new Date(2018,1,16,9,0,0);
		SE("lblClientTime",dtNow.toString());
		SE("lblUTCTime",dtNow.toUTCString());
	}	
	
	function SetPrevCurNextValues()
	{
		//so! search through aryCycle and find ConstKnownValue.Name
		var KnownIDX=myQuests.findIDXOfValue(ConstKnownValue.Name);
		if(KnownIDX!=-1)
		{
			var nowEpoch = new Date().getTime();
			var Diff= nowEpoch - ConstKnownValue.EpochTime;			
			var NumHours = Math.floor(Diff / OneHour);			
			
			var currentIDX = myQuests.MoveIDXForward(KnownIDX,NumHours);
			var CurrentEpoch=(ConstKnownValue.EpochTime+(OneHour*NumHours));
		
			var UIStartEpoch =  CurrentEpoch - (NumBack*OneHour)
			var UIStartIDX = myQuests.MoveIDXBackward(currentIDX,NumBack);
			for(var i=0; i < (1+NumBack+NumForward);i++)
			{
				var qt = new QuestAndTime( myQuests.getAt(myQuests.MoveIDXForward(UIStartIDX,i)), UIStartEpoch + (i*OneHour));
				AppendRow(qt, qt.EpochTime == CurrentEpoch);
			}
		}
	}
	function bodyLoad()
	{
		UpdateUITimes();
		var trKnownValue = document.getElementById("trKnownValue");
		if(trKnownValue!=undefined){	ConstKnownValue.setRow(trKnownValue);}
		SetPrevCurNextValues();
		var oAutoUpdate=getParameterByName("AutoUpdate");
		console.log(oAutoUpdate);
		if(oAutoUpdate=="true")
		{
			tTimeUpdater = window.setInterval(function (){tmTick();}, 1000);
		}
	}
	
</script>
</head>
<body onload="bodyLoad();">
	<table cellpadding="5" cellspacing="5" border="1px">
		<tr><th>Local Time:</th><td><span id="lblClientTime"></span></td></tr>
		<tr><th>UTC Time:</th><td><span id="lblUTCTime"></span></td></tr>
	</table>
<a href="?AutoUpdate=true">AutoUpdate</a> - <a href="?AutoUpdate=false">No AutoUpdate</a><br/>
	<br/>
	<table cellpadding="5" cellspacing="5" border="1px">
		<thead style="display:none;">
			<tr><th colspan="3">Known Value</th><tr>
			<tr id="trKnownValue"></tr>
			<tr><td colspan="2" id="Scratch"></td></tr>
		</thead>
		<thead><tr><th>Quest Name</th><th>Quest Time</th><th>Start Time</th></tr></thead>
		
		<tbody id="tblDerived">
		</tbody>
	</table>
</body>
</html>
